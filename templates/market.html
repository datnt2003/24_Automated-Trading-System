{% extends "base.html" %}

{% block content %}
<style>
    /* Custom styles */
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #f9fafb;
        margin: 0;
        padding: 0;
    }

    .container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
    }

    .section-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .section-header h1 {
        font-size: 36px;
        color: #333;
        margin-bottom: 10px;
        text-transform: uppercase;
    }

    .section-header p {
        font-size: 18px;
        color: #666;
    }

    .filter-input {
        width: 100%;
        padding: 15px;
        margin-bottom: 20px;
        border: none;
        border-radius: 8px;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-size: 16px;
        box-sizing: border-box;
    }

    .select-wrapper {
        position: relative;
        margin-bottom: 20px;
    }

    .select-wrapper select {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 8px;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-size: 16px;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background: transparent;
        cursor: pointer;
    }

    .select-wrapper:after {
        content: '\25BC';
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        color: #666;
    }

    .button-wrapper {
        text-align: right;
    }

    .button-wrapper button {
        padding: 15px 30px;
        background-color: #4CAF50;
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .button-wrapper button:hover {
        background-color: #45a049;
    }

    /* Table styles */
    .stock-table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 8px;
        overflow: hidden;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .stock-table th,
    .stock-table td {
        padding: 15px;
        text-align: center;
        border-bottom: 1px solid #ddd;
    }

    .stock-table th {
        background-color: #007bff;
        color: #fff;
        text-transform: uppercase;
    }

    .stock-table tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    .stock-table tbody tr:hover {
        background-color: #f1f1f1;
    }

    .stock-table td {
        color: #333;
    }

    .stock-table .btn {
        padding: 10px 20px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .stock-table .btn:hover {
        background-color: #0056b3;
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.6);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
    }
</style>

<div class="container">
    <div class="section-header">
        <h1>Welcome to Stock Information</h1>
        <p>Explore real-time stock data</p>
    </div>
    <input type="text" id="symbol-filter" class="filter-input" placeholder="Filter by Symbol...">
    <div class="select-wrapper">
        <select id="chart-options">
            <option value="LastPrice">Last Price</option>
            <option value="LastVol">Last Volume</option>
            <option value="BidPrice1">Bid Price</option>
            <option value="BidVol1">Bid Volume</option>
            <option value="AskPrice1">Ask Price</option>
            <option value="AskVol1">Ask Volume</option>
        </select>
    </div>
    <div class="button-wrapper">
        <button id="show-chart-button">Show Chart</button>
    </div>
    <table class="stock-table">
        <thead>
            <tr>
                <th>Symbol</th>
                <th>Last Price</th>
                <th>Last Volume</th>
                <th>Bid Price</th>
                <th>Bid Volume</th>
                <th>Ask Price</th>
                <th>Ask Volume</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="stock-table-body">
            <!-- Dynamic data rows will be added here -->
        </tbody>
    </table>
</div>

<!-- Modal -->
<div id="chart-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Stock Chart</h2>
        <canvas id="chart"></canvas>
        <p>This is the chart representing stock information.</p>
        <button id="close-chart-modal" class="btn">Close</button>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        var socket = io();
        var chartData = sessionStorage.getItem('marketData') ? JSON.parse(sessionStorage.getItem('marketData')) : {}; // Đối tượng lưu trữ dữ liệu từ máy chủ
        var tableBody = document.getElementById('stock-table-body');
        var chartLabels = []; // Mảng lưu trữ nhãn biểu đồ
        var selectedOption = "LastPrice"; // Tuỳ chọn mặc định cho biểu đồ

        // Hàm để tải dữ liệu từ sessionStorage khi trang được tải lại hoặc chuyển sang một trang mới
        function loadChartDataFromSessionStorage() {
            var storedChartData = sessionStorage.getItem('marketData');
            if (storedChartData) {
                chartData = JSON.parse(storedChartData);
                // Cập nhật bảng dữ liệu với dữ liệu từ sessionStorage
                Object.keys(chartData).forEach(function (symbol) {
                    updateTableRow(symbol, chartData[symbol]);
                });
            }
        }

        // Gọi lại hàm để tải dữ liệu từ sessionStorage khi trang được tải lại hoặc chuyển sang một trang mới
        loadChartDataFromSessionStorage();

        // Hàm cập nhật hàng trong bảng dữ liệu và lưu trữ dữ liệu vào sessionStorage
        function updateTableRow(symbol, data) {
            if (!chartData[symbol]) {
                chartData[symbol] = {};
            }
            chartData[symbol].LastPrice = data.LastPrice;
            chartData[symbol].LastVol = data.LastVol;
            chartData[symbol].BidPrice1 = data.BidPrice1;
            chartData[symbol].BidVol1 = data.BidVol1;
            chartData[symbol].AskPrice1 = data.AskPrice1;
            chartData[symbol].AskVol1 = data.AskVol1;

            if (chartLabels.indexOf(symbol) === -1) {
                chartLabels.push(symbol);
            }

            if (!document.getElementById(`row-${symbol}`)) {
                var newRow = tableBody.insertRow();
                newRow.id = `row-${symbol}`;
                var symbolCell = newRow.insertCell();
                symbolCell.textContent = symbol;
                symbolCell.id = `symbol-${symbol}`;
                newRow.insertCell().id = `last-price-${symbol}`;
                newRow.insertCell().id = `last-volume-${symbol}`;
                newRow.insertCell().id = `bid-price-${symbol}`;
                newRow.insertCell().id = `bid-volume-${symbol}`;
                newRow.insertCell().id = `ask-price-${symbol}`;
                newRow.insertCell().id = `ask-volume-${symbol}`;
                var actionCell = newRow.insertCell();
                var buyButton = document.createElement('button');
                buyButton.className = 'btn btn-success';
                buyButton.textContent = 'Buy';
                buyButton.addEventListener('click', function () {
                    buyStock(symbol);
                });
                actionCell.appendChild(buyButton);
            }
            var row = document.getElementById(`row-${symbol}`);
            row.cells[1].textContent = chartData[symbol].LastPrice;
            row.cells[2].textContent = chartData[symbol].LastVol;
            row.cells[3].textContent = chartData[symbol].BidPrice1;
            row.cells[4].textContent = chartData[symbol].BidVol1;
            row.cells[5].textContent = chartData[symbol].AskPrice1;
            row.cells[6].textContent = chartData[symbol].AskVol1;

            // Lưu trữ dữ liệu vào sessionStorage sau mỗi lần cập nhật
            sessionStorage.setItem('marketData', JSON.stringify(chartData));
        }
        function buyStock(symbol) {
            var quantity = prompt(`Enter quantity to buy for ${symbol}:`);
            if (quantity && !isNaN(quantity)) {
                fetch('/trade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        quantity: parseInt(quantity),
                        trade_type: 'buy'
                    }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Purchase successful!');
                            window.location.href = '/portfolio'; // Redirect to portfolio page
                        } else {
                            alert('Purchase failed: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Purchase failed: ' + error.message);
                    });
            } else {
                alert('Invalid quantity');
            }
        }
        // Lắng nghe sự kiện 'market_data' từ máy chủ
        socket.on('market_data', function (data) {
            if (typeof data.Content === "string") {
                data.Content = JSON.parse(data.Content);
            }
            updateTableRow(data.Content.Symbol, data.Content);
        });

        // Lắng nghe sự kiện thay đổi tuỳ chọn biểu đồ
        var chartOptionsSelect = document.getElementById('chart-options');
        chartOptionsSelect.addEventListener('change', function (event) {
            selectedOption = event.target.value;
            updateChart();
        });

        // Lắng nghe sự kiện nhập vào bộ lọc ký tự
        const symbolFilterInput = document.getElementById('symbol-filter');
        symbolFilterInput.addEventListener('input', function () {
            const filterText = this.value.toLowerCase();
            const rows = tableBody.querySelectorAll('tr');

            rows.forEach(row => {
                const symbolCell = row.querySelector('td:first-child');
                if (symbolCell) {
                    const symbol = symbolCell.textContent.toLowerCase();
                    row.style.display = symbol.includes(filterText) ? 'table-row' : 'none';
                }
            });

            // Cập nhật biểu đồ sau khi lọc
            updateChart();
        });

        // Lắng nghe sự kiện click nút hiển thị biểu đồ
        var modal = document.getElementById("chart-modal");
        var btn = document.getElementById("show-chart-button");
        var span = document.getElementsByClassName("close")[0];
        btn.onclick = function () {
            modal.style.display = "block";
            updateChart(); // Cập nhật biểu đồ khi hiển thị modal
        }

        // Lắng nghe sự kiện click để đóng modal
        span.onclick = function () {
            modal.style.display = "none";
        }

        // Lắng nghe sự kiện click bên ngoài modal
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // Hàm cập nhật biểu đồ
        function updateChart() {
            const filterText = symbolFilterInput.value.toLowerCase();
            const ctx = document.getElementById('chart').getContext('2d');
            const filteredLabels = chartLabels.filter(label => label.toLowerCase().includes(filterText));
            const filteredData = filteredLabels.map(label => chartData[label][selectedOption]);

            // Xóa biểu đồ cũ trước khi vẽ biểu đồ mới
            if (window.myChart) {
                window.myChart.destroy();
            }

            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: filteredLabels,
                    datasets: [{
                        label: selectedOption,
                        data: filteredData,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        // Hàm để gọi lại endpoint khi trang được tải
        function fetchData() {
            fetch('/fetch_market_data') // Đổi '/fetch_market_data' thành endpoint của bạn
                .then(response => response.json())
                .then(data => {
                    // Xử lý dữ liệu nhận được ở đây, có thể cập nhật giao diện người dùng
                    updateTableWithData(data); // Gọi hàm để cập nhật bảng dữ liệu
                })
                .catch(error => {
                    console.error('Error fetching market data:', error);
                });
        }

        // Gọi lại fetchData() khi trang được tải
        fetchData();
    });
</script>
{% endblock %}